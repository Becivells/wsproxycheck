<!doctype html>
<html>
<head>
    <title>Proxy Detect</title>
    <meta charset="utf-8">
    <style>
        body {
            font-family: monospace;
        }
    </style>
</head>
<body>
<h2>Proxy Detect (TCP Win)</h2>
<div>
    status: <span id="textProxy">...</span>
</div>
<script>
    var buf = new Uint8Array(1024 * 150)
    host = window.location.host;
    var ws = new WebSocket("ws://" + host + "/echo")
    console.log('connecting...')
    var lastBufLen = -1

    function update() {
        var bufLen = ws.bufferedAmount
        if (bufLen !== lastBufLen) {
            lastBufLen = bufLen
            console.log('bufferedAmount:', bufLen, performance.now())
        }
    }

    var tid
    //打开 websocket
    ws.onopen = function () {
        console.log('onopen')
    }
    // 发送消息
    ws.onmessage = function (e) {
        console.log('onmessage. recv: %d bytes', e.data.length)
        send()
        send()
        console.log(ws.bufferedAmount)
        console.log('start write:', performance.now())
        // tid = setInterval(update, 1)

        setTimeout(function () {
            console.log(ws.bufferedAmount)
            // 全部发出去则为代理
            textProxy.textContent = !ws.bufferedAmount
        }, 1000)
    }
    ws.onclose = function () {
        console.log('onclose')
        // update()
        clearInterval(tid)
    }
    ws.onerror = function () {
        console.log('onerror')
    }

    function send() {
        ws.send(buf)
    }
</script>
</body>
</html>